<!DOCTYPE html>
<html>

<head>
	<script src="https://code.jquery.com/jquery-3.6.0.js"
		integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	<script src="/static/cis444.js"></script>
</head>

<body>

	<script>
		function addUserPressed() {
			console.log("clicked button to add a new user");
			$('#login').hide();
			$('#addNewUser').show();
			return true;
		}
	</script>

	<script>
		function logOut() {
			console.log("clicked button to logout");
			jwt = null;
			while ($('#bookList').children('option').length > 0) {
				$("#bookList").children('option').remove();
			}
			$('#books').hide();
			$('#login').show();
			return true;
		}
	</script>

	<script>
		function goToLogInPressedOnCreateUser() {
			console.log("clicked button to return from sign up page to log in page");
			$('#addNewUser').hide();
			$('#login').show();
			return true;
		}
	</script>

	<script>
		function addNewUserAction() {
			$.post("/open_api/createNewUser", {
					"username": $('#username').val(),
					"password": $('#password').val()
				},
				function (data) {
					alert(data.message);
					$('#addNewUser').hide();
					$('#login').show();
				}, "json").fail(function (response) {
				//this gets called if the server throws an error
				console.log("error");
				console.log(response);
			});
			return false;
		}

		function loginAction() {
			$.post("/open_api/login", {
					"username": $('#username').val(),
					"password": $('#password').val()
				},
				function (data, textStatus) {
					//this gets called when browser receives response from server
					//console.log(data.token);
					//Set global JWT
					jwt = data.token;
					//make secure call with the jwt
					get_books();
				}, "json").fail(function (response) {
				//this gets called if the server throws an error
				console.log("error");
				console.log(response);
			});
			return false;
		}

		function get_books() {
			//make secure call with the jwt
			secure_get_with_token("/secure_api/get_books", {}, function (data) {
					//console.log("got books");
					//console.log(data);
					for (var i = 0; i < data.name.length; i++) {
						$('#bookList').append($('<option>', {
							value: data.name[i],
							text: 'Name: ' + data.name[i] + ' Price: $' + data.price[i]
						}));
					}
					//console.log("All books listed");
					$('#login').hide();
					$('#books').show();
				},
				function (err) {
					console.log(err)
				});
		}

		function buyBookAction() {
			var book = document.getElementById('bookList');
			console.log(book);
			var bookBought = book.options[book.selectedIndex].value;
			console.log(bookBought);

			//make secure call with the jwt
			secure_get_with_token("/secure_api/buyBook", {
				bookBought
				}, function (data) {
					console.log("bought books");
					alert(data.message);
				},
				function (err) {
					console.log(err)
				});
		}
	</script>

	<div id="login">
		<form id="loginForm">
			<label for="username">Username:</label><br>
			<input type="text" id="username" name="username" value="JP"><br>
			<label for="password">Password:</label><br>
			<input type="password" id="password" name="password" value="Password"><br><br>
			<input type="button" value="Login" id="Login" onclick="return loginAction();">
			<input type="button" value="Create New User" onclick="return addUserPressed();">
		</form>
	</div>

	<div id="addNewUser" style="display:none">
		<form id="addNewUserForm">
			<label for="username">Username:</label><br>
			<input type="text" id="username" name="username" value="JP"><br>
			<label for="password">New Password:</label><br>
			<input type="password" id="password" name="password" value="Password"><br><br>
			<input type="button" value="Submit" onclick="return addNewUserAction();">
			<input type="button" value="Go Back" onclick="return goToLogInPressedOnCreateUser();">
		</form>
	</div>

	<div id="books" style="display:none">
		<form id="bookDisplay">
			<h1>Buy me</h1>
			<select name="bookList" id="bookList"></select><br>
			<input type="button" value="Purchase Book" id="purchaseButton" onclick="return buyBookAction();">
			<input type="button" value="Log Out" onclick="return logOut();">
		</form>
	</div>


</body>

</html>